# 統合メタデータ管理基盤API案
2020.01.28 NEC 岡田 耕平

本ドキュメントは、実施項目「II-①統合メタデータ管理基盤」で実現する統合メタデータ管理基盤を利用するためのAPIの設計方針とAPI仕様の概要について記述する。

## 統合メタデータ管理基盤
* 統合メタデータ管理基盤は、NEDO DBを管理、運用するために必要なメタデータを分類して永続化する。
* 統合メタデータ管理基盤は、各コンポーネント(実行エンジンなど)がメタデータにアクセスするためのAPIを提供する。
* NEDO DBではメタデータを以下の2種類に分け、統合メタデータ管理基盤では主に1.のコモンメタデータについてデータ構造やAPIを提供する。
 1. コモンメタデータ(仮)
    * テーブルやカラムなどのデータベースシステムとして動作するために必要なメタデータ
 2. プライベートメタデータ(仮)
    * 各コンポーネント固有の設定情報など
* 統合メタデータ管理基盤は、メタデータの世代(バージョン)を管理する（どの単位で管理するかは検討中）。 **※V1はスコープ外**
* 統合メタデータ管理基盤は、メタデータにアクセスするための権限を管理する。 **※V1はスコープ外**
* 統合メタデータ管理基盤は、メタデータに更新が発生した場合に、シグナル等で各コンポーネントにメタデータの更新を知らせる。 **※必要性を含めて検討中**

## メタデータ分類
* 統合メタデータ管理基盤はメタデータを分類ごとに分けて管理する。
* 分類ごとに管理用テーブル（メタデータテーブル）を用意し、各コンポーネントはメタデータテーブルの単位で統合メタデータ管理基盤にアクセスする。
* 各分類のメタデータテーブルの仕様はNECが設計し、プロジェクト内に展開する。
### V1でのメタデータの分類 ※変更の可能性あり
* テーブルメタデータ
* カラムメタデータ
* 制約メタデータ
* インデックスメタデータ？

## メタデータAPI基本アーキテクチャ
* 統合メタデータ管理基盤は、メタデータを格納するために boost の boost::property_tree ライブラリを使用する。
* 統合メタデータ管理基盤は、メタデータテーブル上のメタデータをproperty_treeオブジェクトに格納して各コンポーネントに提供する。
* 各コンポーネントは、property_treeオブジェクトにメタデータを格納し、統合メタデータ管理基盤にメタデータの追加や更新を依頼する。
* メタデータに変更(add/set/removeなど)を加えると、自動的にメタデータのバージョンが更新される。
* 統合メタデータ管理基盤は、性能向上を目的としたバッファリングや遅延書込み等は行わないため、メタデータ管理基盤を通じたメタデータ操作のコストは高くなる。

## Metadataクラス（基底クラス）
* メタデータを分類(tableやcolumnなど)ごとにアクセスするためのクラス。
* 実際にはmetadataクラスから派生したクラスを利用してメタデータにアクセスする。
* 派生クラスでは管理するメタデータの内容に合わせてメソッドが実装される（必ずしも基底クラスのメソッドがすべて派生クラスで実装されるわけではない）。

### メソッド一覧

|メソッド名|説明|
|:---------|:---|
|static load()|メタデータテーブルの内容をproperty_treeオブジェクトに読み込む。|
|static save()|property_treeオブジェクトの内容でメタデータテーブルを上書きする。|
|version()|Metadataオブジェクトに読み込まれているメタデータのバージョン。|
|load()|Metadataオブジェクトにメタデータを読み込む。|
|add()|オブジェクト単位でメタデータを追加する（tableであれば１テーブル）。|
|get()|オブジェクト単位でメタデータを読み込む（tableであれば１テーブル）。|
|set()|オブジェクト単位でメタデータを書き込む（tableであれば１テーブル）。|
|remove()|オブジェクト単位でメタデータを削除する（tableであれば１テーブル）。|
|next()|次のオブジェクトを取得する。|

## TableMetadataクラス
テーブルに関するメタデータを管理する。

### メソッド一覧
|メソッド名|説明|
|:---------|:---|
|version()|TableMetadataオブジェクトに読み込まれているメタデータのバージョン。|
|load()|tableメタデータテーブルを読み込む。|
|add()|テーブルオブジェクトを追加する。|
|get()|指定したIDまたは名前を持つテーブルのメタデータを取得する。|
|set()|指定したIDまたは名前を持つテーブルのメタデータを更新する。|
|remove()|指定したIDまたは名前を持つテーブルのメタデータを削除する。|
|next()|次のオブジェクトを取得する。|

## ColumnMetadataクラス
カラムに関するメタデータを管理する。

## ConstraintMetadataクラス
制約に関するメタデータを管理する。

## 想定する使用方法
各コンポーネントからの使用方法について説明する。
* メタデータをすべて読み込む。(方法1)
   1. Metadata::load( database, METADATA_TABLE, version, ptree );
   1. BOOST_FOREACH ( const ptree::value_type& child, ptree.get_child("") ) { childを使う処理 }

* メタデータ(オブジェクト)をすべて読み込む。(方法2)
  1. table = TableMetadata( database );
  1. table.load( version );
  1. while( table.next( ptree ) ) { ptreeを使う処理 }

* オブジェクト(テーブルメタデータ)を追加する。
  1. ptree.put( "name", "employee" );　　　　　　// メタデータをproperty_treeに詰め込む
  1. table = TableMetadata( database, version );　// TableMetadataオブジェクトの生成と読み込み
  1. table.add( ptree, &id );　　　　　　　　　　// 追加したオブジェクトのIDを返す

* オブジェクト(テーブルメタデータ)を更新する。
  1. table = TableMetadata( database, version );
  1. table.get( id, ptree );
  1. ptree.put( "name", "employee_temp" );
  1. table.set( id, ptree );

* オブジェクト(テーブルメタデータ)を削除する。
  1. table = TableMetadata( database, version );
  1. table.remove( "employee_temp" );

以上
