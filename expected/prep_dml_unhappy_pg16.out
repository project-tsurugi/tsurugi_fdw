/* Test case: unhappy path - Unsupported DML statement patterns (preparation) - PostgreSQL 16 */
/* Test case: unhappy path - invalid PREPARE statement */
-- Test setup: DDL of the Tsurugi
SELECT tg_execute_ddl('
  CREATE TABLE fdw_invalid_test (id INTEGER)
', 'tsurugidb');
 tg_execute_ddl 
----------------
 CREATE TABLE
(1 row)

-- Test setup: DDL of the PostgreSQL
CREATE FOREIGN TABLE fdw_invalid_test (id integer) SERVER tsurugidb;
-- invalid PREPARE statement
PREPARE invalid (int) AS SELECT $1 FROM fdw_invalid_test;
EXECUTE invalid(1);
ERROR:  tsurugi_fdw : Contains an unsupported target entry. (8)
DEALLOCATE invalid;
-- Test teardown: DDL of the PostgreSQL
DROP FOREIGN TABLE fdw_invalid_test;
-- Test teardown: DDL of the Tsurugi
SELECT tg_execute_ddl('DROP TABLE fdw_invalid_test', 'tsurugidb');
 tg_execute_ddl 
----------------
 DROP TABLE
(1 row)

/* Test case: unhappy path - Unsupported SELECT statement patterns */
-- Test setup: DDL of the Tsurugi
SELECT tg_execute_ddl('
  CREATE TABLE fdw_sel_unsupported_test (
    id INTEGER PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    value NUMERIC(10,2) NOT NULL,
    ref_id INT,
    manager_id INT
  )
', 'tsurugidb');
 tg_execute_ddl 
----------------
 CREATE TABLE
(1 row)

-- Test setup: DDL of the PostgreSQL
CREATE FOREIGN TABLE fdw_sel_unsupported_test (
  id integer,
  name varchar(100),
  value numeric,
  ref_id integer,
  manager_id integer
) SERVER tsurugidb;
-- Arithmetic operation
PREPARE fdw_prepare_sel AS
  SELECT id, name, ((value / 10000) * ref_id)::int AS lank
    FROM fdw_sel_unsupported_test;
EXECUTE fdw_prepare_sel;
ERROR:  tsurugi_fdw : Contains an unsupported target entry. (13)
DEALLOCATE fdw_prepare_sel;
-- CASE WHEN
PREPARE fdw_prepare_sel (integer, integer) AS
  SELECT
    id, name,
    CASE
      WHEN value >= $1 THEN 'High'
      WHEN value >= $2 THEN 'Medium'
      ELSE 'Low' END AS lank
    FROM fdw_sel_unsupported_test;
EXECUTE fdw_prepare_sel (100000, 75000);
ERROR:  tsurugi_fdw : Contains an unsupported target entry. (30)
DEALLOCATE fdw_prepare_sel;
-- WINDOW
PREPARE fdw_prepare_sel AS
  SELECT id, name, value, RANK() OVER w AS rk
    FROM fdw_sel_unsupported_test
    WINDOW w AS (ORDER BY value DESC);
EXECUTE fdw_prepare_sel;
ERROR:  tsurugi_fdw : Contains an unsupported target entry. (11)
DEALLOCATE fdw_prepare_sel;
-- GROUP BY ALL
PREPARE fdw_prepare_sel AS
  SELECT ref_id, COUNT(*), SUM(value)
    FROM fdw_sel_unsupported_test
    GROUP BY ALL ref_id
    ORDER BY ref_id;
EXECUTE fdw_prepare_sel;
ERROR:  Failed to execute remote SQL.
HINT:  Failed to prepare the statement to Tsurugi. error: SERVER_ERROR(13)
Tsurugi Error: SYNTAX_EXCEPTION (SQL-03001: compile failed with message:"appeared unexpected token: "ALL", expected one of {(, +, -, ?, ABS, ...}" region:"region(begin=85, end=88)")
CONTEXT:  SQL query:   SELECT ref_id, COUNT(*), SUM(value)     FROM fdw_sel_unsupported_test     GROUP BY ALL ref_id     ORDER BY ref_id
DEALLOCATE fdw_prepare_sel;
-- GROUP BY DISTINCT
PREPARE fdw_prepare_sel AS
  SELECT ref_id, COUNT(*), SUM(value)
    FROM fdw_sel_unsupported_test
    GROUP BY DISTINCT ref_id
    ORDER BY ref_id;
EXECUTE fdw_prepare_sel;
ERROR:  Failed to execute remote SQL.
HINT:  Failed to prepare the statement to Tsurugi. error: SERVER_ERROR(13)
Tsurugi Error: SYNTAX_EXCEPTION (SQL-03001: compile failed with message:"appeared unexpected token: "DISTINCT", expected one of {(, +, -, ?, ABS, ...}" region:"region(begin=85, end=93)")
CONTEXT:  SQL query:   SELECT ref_id, COUNT(*), SUM(value)     FROM fdw_sel_unsupported_test     GROUP BY DISTINCT ref_id     ORDER BY ref_id
DEALLOCATE fdw_prepare_sel;
-- FETCH FIRST ... WITH TIES
PREPARE fdw_prepare_sel AS
  SELECT * FROM fdw_sel_unsupported_test ORDER BY value
    FETCH FIRST 2 ROWS WITH TIES;
EXECUTE fdw_prepare_sel;
ERROR:  Failed to execute remote SQL.
HINT:  Failed to prepare the statement to Tsurugi. error: SERVER_ERROR(13)
Tsurugi Error: SYNTAX_EXCEPTION (SQL-03001: compile failed with message:"appeared unexpected token: "FETCH", expected one of {<END_OF_FILE>, %, (, *, +, ...}" region:"region(begin=60, end=65)")
CONTEXT:  SQL query:   SELECT * FROM fdw_sel_unsupported_test ORDER BY value     FETCH FIRST 2 ROWS WITH TIES
DEALLOCATE fdw_prepare_sel;
-- FETCH NEXT ... WITH TIES
PREPARE fdw_prepare_sel AS
  SELECT * FROM fdw_sel_unsupported_test ORDER BY value
    FETCH NEXT 2 ROWS WITH TIES;
EXECUTE fdw_prepare_sel;
ERROR:  Failed to execute remote SQL.
HINT:  Failed to prepare the statement to Tsurugi. error: SERVER_ERROR(13)
Tsurugi Error: SYNTAX_EXCEPTION (SQL-03001: compile failed with message:"appeared unexpected token: "FETCH", expected one of {<END_OF_FILE>, %, (, *, +, ...}" region:"region(begin=60, end=65)")
CONTEXT:  SQL query:   SELECT * FROM fdw_sel_unsupported_test ORDER BY value     FETCH NEXT 2 ROWS WITH TIES
DEALLOCATE fdw_prepare_sel;
-- OFFSET FETCH FIRST ... WITH TIES
PREPARE fdw_prepare_sel AS
  SELECT * FROM fdw_sel_unsupported_test ORDER BY value
    OFFSET 1 FETCH FIRST 2 ROWS WITH TIES;
EXECUTE fdw_prepare_sel;
ERROR:  Failed to execute remote SQL.
HINT:  Failed to prepare the statement to Tsurugi. error: SERVER_ERROR(13)
Tsurugi Error: SYNTAX_EXCEPTION (SQL-03001: compile failed with message:"appeared unexpected token: "OFFSET", expected one of {<END_OF_FILE>, %, (, *, +, ...}" region:"region(begin=60, end=66)")
CONTEXT:  SQL query:   SELECT * FROM fdw_sel_unsupported_test ORDER BY value     OFFSET 1 FETCH FIRST 2 ROWS WITH TIES
DEALLOCATE fdw_prepare_sel;
-- OFFSET FETCH NEXT ... WITH TIES
PREPARE fdw_prepare_sel AS
  SELECT * FROM fdw_sel_unsupported_test ORDER BY value
    OFFSET 1 FETCH NEXT 2 ROWS WITH TIES;
EXECUTE fdw_prepare_sel;
ERROR:  Failed to execute remote SQL.
HINT:  Failed to prepare the statement to Tsurugi. error: SERVER_ERROR(13)
Tsurugi Error: SYNTAX_EXCEPTION (SQL-03001: compile failed with message:"appeared unexpected token: "OFFSET", expected one of {<END_OF_FILE>, %, (, *, +, ...}" region:"region(begin=60, end=66)")
CONTEXT:  SQL query:   SELECT * FROM fdw_sel_unsupported_test ORDER BY value     OFFSET 1 FETCH NEXT 2 ROWS WITH TIES
DEALLOCATE fdw_prepare_sel;
-- Test teardown: DDL of the PostgreSQL
DROP FOREIGN TABLE fdw_sel_unsupported_test;
-- Test teardown: DDL of the Tsurugi
SELECT tg_execute_ddl('DROP TABLE fdw_sel_unsupported_test', 'tsurugidb');
 tg_execute_ddl 
----------------
 DROP TABLE
(1 row)

